<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bookstore CRUD (Spring Boot + JWT)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<style>
  #captureArea { overflow: hidden; }
  #selectionRect { pointer-events: none; }
  /* canvas’ın CSS boyutları element boyutuna eşlensin */
  #snapCanvas { image-rendering: crisp-edges; }
</style>

<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Bookstore</a>
    <div class="ms-auto text-white">
      <span id="userInfo"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light ms-2 d-none">Çıkış</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">Giriş</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Kullanıcı Adı</label>
            <input id="username" class="form-control" value="admin">
          </div>
          <div class="mb-2">
            <label class="form-label">Şifre</label>
            <input id="password" type="password" class="form-control" value="admin">
            <div class="form-text">Varsayılan kullanıcı: admin / şifre: admin (DB hash uyumlu)</div>
          </div>
          <button id="btnLogin" class="btn btn-primary w-100">Giriş Yap</button>
          <div id="loginAlert" class="alert alert-danger mt-2 d-none"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Yardım</div>
        <div class="card-body small">
          <ul>
            <li>Önce giriş yapın (JWT alır).</li>
            <li>Token otomatik olarak Authorization: Bearer ... başlığına eklenir.</li>
            <li>CRUD sekmelerini kullanarak kayıt ekle/güncelle/sil yapabilirsiniz.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <ul class="nav nav-tabs" id="crudTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabBooks">Kitaplar</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabCustomers">Müşteriler</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabOrders">Siparişler</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabOcr">OCR</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabSnap">ScreenSnap</a></li>


      </ul>
      <div class="tab-content border border-top-0 bg-white p-3">
        <!-- Books -->
        <div class="tab-pane fade show active" id="tabBooks">
          <form id="bookForm" class="row g-2">
            <input type="hidden" id="bookId">
            <div class="col-md-6"><label class="form-label">Ad</label><input id="bookName" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Yazar(lar)</label><input id="bookAuthors" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">ISBN</label><input id="bookIsbn" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Fiyat</label><input id="bookPrice" class="form-control" type="number" step="0.01"></div>
            <div class="col-md-4"><label class="form-label">Yayın Tarihi</label><input id="bookPublishedOn" class="form-control" type="date"></div>
            <div class="col-md-12"><label class="form-label">Yayınevi</label><input id="bookPublisher" class="form-control"></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="bookReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="booksTable">
            <thead><tr><th>ID</th><th>Ad</th><th>Yazar</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Customers -->
        <div class="tab-pane fade" id="tabCustomers">
          <form id="customerForm" class="row g-2">
            <input type="hidden" id="customerId">
            <div class="col-md-6"><label class="form-label">Ad</label><input id="custName" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Soyad</label><input id="custSurname" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Email</label><input id="custEmail" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Telefon</label><input id="custPhone" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Şehir</label><input id="custCity" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Ülke/İl</label><input id="custCountry" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Posta Kodu</label><input id="custPostal" class="form-control"></div>
            <div class="col-md-12"><label class="form-label">Adres</label><input id="custAddress" class="form-control"></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="customerReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="customersTable">
            <thead><tr><th>ID</th><th>Ad Soyad</th><th>Email</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Orders -->
        <div class="tab-pane fade" id="tabOrders">
          <form id="orderForm" class="row g-2">
            <input type="hidden" id="orderId">
            <div class="col-md-4"><label class="form-label">Tarih</label><input id="orderDate" type="date" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Kitap</label><select id="orderBook" class="form-select"></select></div>
            <div class="col-md-4"><label class="form-label">Müşteri</label><select id="orderCustomer" class="form-select"></select></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="orderReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="ordersTable">
            <thead><tr><th>ID</th><th>Tarih</th><th>Kitap</th><th>Müşteri</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- OCR -->
        <div class="tab-pane fade" id="tabOcr">
          <form id="ocrForm" class="row g-2" enctype="multipart/form-data">
            <div class="col-md-8">
              <label class="form-label">Dosya (PNG/JPG/WEBP/PDF)</label>
              <input id="ocrFile" type="file" class="form-control"
                     accept=".png,.jpg,.jpeg,.webp,.pdf" required>
              <div class="form-text">En iyi sonuç için net görüntü kullanın.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Dil</label>
              <select id="ocrLang" class="form-select">
                <option value="tur" selected>Türkçe (tur)</option>
                <option value="eng">English (eng)</option>
                <option value="tur+eng">Türkçe+İngilizce (tur+eng)</option>
              </select>
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-success" id="btnOcrStart">
                Metni Çıkar
              </button>
              <button type="button" class="btn btn-secondary" id="btnOcrClear">
                Temizle
              </button>
              <div id="ocrBusy" class="ms-2 d-none">
                <span class="spinner-border spinner-border-sm"></span>
                <span class="ms-1">İşleniyor…</span>
              </div>
            </div>
          </form>

          <hr>
          <div class="row">
            <div class="col-md-6">
              <div class="border rounded p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Önizleme</strong>
                  <small class="text-muted" id="ocrPreviewInfo"></small>
                </div>
                <div id="ocrPreviewBox" class="ratio ratio-4x3 bg-light d-flex
             align-items-center justify-content-center text-muted">
                  Dosya seçilmedi
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Çıkarılan Metin</label>
              <textarea id="ocrText" class="form-control" rows="12" readonly></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" id="btnCopyOcr">Kopyala</button>
                <button class="btn btn-outline-secondary btn-sm" id="btnDownloadTxt">TXT indir</button>
              </div>
              <div id="ocrAlert" class="alert alert-danger mt-2 d-none"></div>
            </div>
          </div>
        </div>







<!-- ScreenSnap -->
<div class="tab-pane fade" id="tabSnap">
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <span>Ekran Yakalama</span>
          <div>
            <button id="btnStartCapture" class="btn btn-sm btn-primary me-1">Ekranı Seç</button>
            <button id="btnFreeze" class="btn btn-sm btn-outline-secondary me-1" disabled>Kare Dondur</button>
            <button id="btnClearCapture" class="btn btn-sm btn-outline-danger" disabled>Temizle</button>
          </div>
        </div>
        <div class="card-body">
          <div class="ratio ratio-16x9 border bg-light position-relative" id="captureArea">
            <video id="screenVideo" class="w-100 h-100" autoplay muted playsinline></video>
            <canvas id="snapCanvas" class="position-absolute top-0 start-0 w-100 h-100 d-none"></canvas>

            <!-- Seçim overlay (canvas üstünde şeffaf layer) -->
            <div id="selectOverlay" class="position-absolute top-0 start-0 w-100 h-100"
                 style="cursor: crosshair; display:none;"></div>
            <div id="selectionRect" class="position-absolute border border-2 border-primary"
                 style="display:none; background: rgba(13,110,253,0.15);"></div>
          </div>
          <div class="mt-2 small text-muted">
            1) “Ekranı Seç” ile ekran paylaşımını aç. 2) “Kare Dondur” ile durdur.
            3) Dondurulan görüntü üzerinde fareyle seçim yap. 4) “Kırp & Kaydet”.
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card">
        <div class="card-header">Bilgiler</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Ana Başlık</label>
            <input id="snapTitle" class="form-control" placeholder="Örn: Hata Ekranı">
          </div>
          <div class="mb-2">
            <label class="form-label">Alt Başlık</label>
            <input id="snapSubtitle" class="form-control" placeholder="Örn: 500 hatası detay">
          </div>
          <div class="d-flex gap-2">
            <button id="btnCropSave" class="btn btn-success" disabled>Kırp & Kaydet</button>
            <button id="btnDownloadLocal" class="btn btn-outline-secondary" disabled>PNG indir</button>
          </div>
          <div id="snapAlert" class="alert alert-danger mt-2 d-none"></div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Kayıtlı Görseller</span>
          <button id="btnRefreshSnaps" class="btn btn-sm btn-outline-primary">Yenile</button>
        </div>
        <div class="card-body">
          <div id="snapsList" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>














      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const api = {
  login: '/api/auth/login',
  books: '/api/books',
  customers: '/api/customers',
  orders: '/api/orders',
  ocr: '/api/ocr',
  snaps: '/api/snaps'


};
let JWT = null;

function setAuthHeader(xhr) {
  if (JWT) xhr.setRequestHeader('Authorization', 'Bearer ' + JWT);
}

function showAlert(el, msg) {
  $(el).removeClass('d-none').text(msg);
  setTimeout(()=> $(el).addClass('d-none'), 2500);
}

$('#btnLogin').on('click', function() {
  $.ajax({
    url: api.login,
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({username: $('#username').val(), password: $('#password').val()}),
    success: function(res){
      JWT = res.token;
      $('#userInfo').text(res.username + ' | ' + res.roles.join(','));
      $('#btnLogout').removeClass('d-none');
      $('.nav-link[href="#tabBooks"]').tab('show');
      refreshAll();
    },
    error: function(xhr){
      let msg = 'Giriş başarısız';
      try {
        const j = xhr.responseJSON;
        if (j && j.detail) msg = j.detail;
      } catch(e){}
      showAlert('#loginAlert', msg);
    }
  });
});

$('#btnLogout').on('click', function(){
  JWT = null;
  $('#userInfo').text('');
  $('#btnLogout').addClass('d-none');
});

// Books CRUD
function refreshBooks(){
  $.ajax({
    url: api.books, method: 'GET', beforeSend: setAuthHeader,
    success: function(rows){
      const tbody = $('#booksTable tbody').empty();
      rows.forEach(r => {
        $('<tr>').append(
          $('<td>').text(r.id),
          $('<td>').text(r.name),
          $('<td>').text(r.authors),
          $('<td>').append(
            $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadBook(r)),
            $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteBook(r.id))
          )
        ).appendTo(tbody);
      });
      // also update order dropdowns
      const sel = $('#orderBook').empty();
      rows.forEach(r => sel.append($('<option>').val(r.id).text(r.name)));
    }
  });
}

function loadBook(b){
  $('#bookId').val(b.id);
  $('#bookName').val(b.name);
  $('#bookAuthors').val(b.authors);
  $('#bookIsbn').val(b.isbn);
  $('#bookPrice').val(b.price);
  $('#bookPublishedOn').val(b.publishedOn);
  $('#bookPublisher').val(b.publisher);
}

function deleteBook(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.books + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshBooks});
}

$('#bookForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    name: $('#bookName').val(),
    authors: $('#bookAuthors').val(),
    isbn: $('#bookIsbn').val(),
    price: $('#bookPrice').val() ? parseFloat($('#bookPrice').val()) : null,
    publishedOn: $('#bookPublishedOn').val(),
    publisher: $('#bookPublisher').val()
  };
  const id = $('#bookId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.books + '/' + id : api.books;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#bookForm')[0].reset(); $('#bookId').val(''); refreshBooks();
  }});
});
$('#bookReset').on('click', ()=> { $('#bookForm')[0].reset(); $('#bookId').val(''); });

// Customers CRUD
function refreshCustomers(){
  $.ajax({url: api.customers, method: 'GET', beforeSend: setAuthHeader, success: function(rows){
    const tbody = $('#customersTable tbody').empty();
    rows.forEach(r => {
      $('<tr>').append(
        $('<td>').text(r.id),
        $('<td>').text(r.name + ' ' + r.surname),
        $('<td>').text(r.email),
        $('<td>').append(
          $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadCustomer(r)),
          $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteCustomer(r.id))
        )
      ).appendTo(tbody);
    });
    const sel = $('#orderCustomer').empty();
    rows.forEach(r => sel.append($('<option>').val(r.id).text(r.name + ' ' + r.surname)));
  }});
}

function loadCustomer(c){
  $('#customerId').val(c.id);
  $('#custName').val(c.name);
  $('#custSurname').val(c.surname);
  $('#custEmail').val(c.email);
  $('#custPhone').val(c.phoneNumber);
  $('#custCity').val(c.city);
  $('#custCountry').val(c.countryRegion);
  $('#custPostal').val(c.postalCode);
  $('#custAddress').val(c.streetAndHouseNumber);
}

function deleteCustomer(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.customers + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshCustomers});
}

$('#customerForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    name: $('#custName').val(),
    surname: $('#custSurname').val(),
    email: $('#custEmail').val(),
    phoneNumber: $('#custPhone').val(),
    city: $('#custCity').val(),
    countryRegion: $('#custCountry').val(),
    postalCode: $('#custPostal').val(),
    streetAndHouseNumber: $('#custAddress').val()
  };
  const id = $('#customerId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.customers + '/' + id : api.customers;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#customerForm')[0].reset(); $('#customerId').val(''); refreshCustomers();
  }});
});
$('#customerReset').on('click', ()=> { $('#customerForm')[0].reset(); $('#customerId').val(''); });

// Orders CRUD
function refreshOrders(){
  $.ajax({url: api.orders, method: 'GET', beforeSend: setAuthHeader, success: function(rows){
    const tbody = $('#ordersTable tbody').empty();
    rows.forEach(r => {
      $('<tr>').append(
        $('<td>').text(r.id),
        $('<td>').text(r.orderDate),
        $('<td>').text(r.book ? r.book.name : ''),
        $('<td>').text(r.customer ? (r.customer.name + ' ' + r.customer.surname) : ''),
        $('<td>').append(
          $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadOrder(r)),
          $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteOrder(r.id))
        )
      ).appendTo(tbody);
    });
  }});
}
function loadOrder(o){
  $('#orderId').val(o.id);
  $('#orderDate').val(o.orderDate);
  $('#orderBook').val(o.book ? o.book.id : '');
  $('#orderCustomer').val(o.customer ? o.customer.id : '');
}
function deleteOrder(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.orders + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshOrders});
}
$('#orderForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    orderDate: $('#orderDate').val(),
    book: { id: $('#orderBook').val() ? parseInt($('#orderBook').val()) : null},
    customer: { id: $('#orderCustomer').val() ? parseInt($('#orderCustomer').val()) : null}
  };
  const id = $('#orderId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.orders + '/' + id : api.orders;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#orderForm')[0].reset(); $('#orderId').val(''); refreshOrders();
  }});
});
$('#orderReset').on('click', ()=> { $('#orderForm')[0].reset(); $('#orderId').val(''); });

function refreshAll(){
  refreshBooks();
  refreshCustomers();
  refreshOrders();
}



// ===== OCR =====
function showOcrBusy(on) {
  $('#ocrBusy').toggleClass('d-none', !on);
  $('#btnOcrStart').prop('disabled', on);
}

function showOcrError(msg) {
  $('#ocrAlert').removeClass('d-none').text(msg);
  setTimeout(()=> $('#ocrAlert').addClass('d-none'), 3500);
}

function previewOcrFile(file) {
  const info = `${file.name} • ${(file.size/1024/1024).toFixed(2)} MB`;
  $('#ocrPreviewInfo').text(info);

  const box = $('#ocrPreviewBox').empty();
  const type = (file.type || '').toLowerCase();

  if (type.includes('pdf')) {
    // PDF için basit placeholder
    box.addClass('d-flex align-items-center justify-content-center')
            .text('PDF seçildi (önizleme yok).');
  } else if (type.startsWith('image/')) {
    const url = URL.createObjectURL(file);
    box.removeClass('d-flex align-items-center justify-content-center')
            .html(`<img src="${url}" class="w-100 h-100 object-fit-contain" alt="preview">`);
  } else {
    box.addClass('d-flex align-items-center justify-content-center')
            .text('Desteklenmeyen format.');
  }
}

$('#ocrFile').on('change', function() {
  const f = this.files && this.files[0];
  if (!f) return;
  // Basit boyut sınırı: 15MB
  if (f.size > 15 * 1024 * 1024) {
    showOcrError('Dosya 15MB limitini aşıyor.');
    this.value = '';
    return;
  }
  previewOcrFile(f);
});

$('#ocrForm').on('submit', function(e){
  e.preventDefault();
  if (!JWT) { showOcrError('Önce giriş yapın.'); return; }

  const fileInput = $('#ocrFile')[0];
  if (!fileInput.files || !fileInput.files[0]) {
    showOcrError('Lütfen bir dosya seçin.');
    return;
  }

  const f = fileInput.files[0];
  const accept = ['image/png','image/jpeg','image/webp','application/pdf'];
  if (!accept.includes(f.type)) {
    showOcrError('Sadece PNG/JPG/WEBP/PDF desteklenir.');
    return;
  }

  const fd = new FormData();
  fd.append('file', f);
  fd.append('lang', $('#ocrLang').val() || 'tur');

  showOcrBusy(true);
  $.ajax({
    url: api.ocr,
    method: 'POST',
    data: fd,
    processData: false,
    contentType: false,
    beforeSend: setAuthHeader,
    success: function(res){
      $('#ocrText').val(res && res.text ? res.text : '');
      if (!res || !res.text) showOcrError('Metin bulunamadı.');
    },
    error: function(xhr){
      const msg = xhr?.responseText || 'OCR sırasında hata oluştu.';
      showOcrError(msg);
    },
    complete: function(){
      showOcrBusy(false);
    }
  });
});

$('#btnOcrClear').on('click', function(){
  $('#ocrForm')[0].reset();
  $('#ocrPreviewBox').attr('class','ratio ratio-4x3 bg-light d-flex align-items-center justify-content-center text-muted')
          .text('Dosya seçilmedi');
  $('#ocrPreviewInfo').text('');
  $('#ocrText').val('');
});

$('#btnCopyOcr').on('click', function(){
  const t = $('#ocrText').val();
  if (!t) return;
  navigator.clipboard.writeText(t).then(()=> {
    $(this).text('Kopyalandı').prop('disabled', true);
    setTimeout(()=> { $('#btnCopyOcr').text('Kopyala').prop('disabled', false); }, 1200);
  });
});

$('#btnDownloadTxt').on('click', function(){
  const t = $('#ocrText').val() || '';
  const blob = new Blob([t], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ocr-output.txt';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});













// ===== ScreenSnap =====
const video = document.getElementById('screenVideo');
const canvas = document.getElementById('snapCanvas');
const overlay = document.getElementById('selectOverlay');
const rect = document.getElementById('selectionRect');

let mediaStream = null;
let frozen = false;
let selection = null; // {x,y,w,h} canvas koordinatlarında

function showSnapError(msg) {
  $('#snapAlert').removeClass('d-none').text(msg);
  setTimeout(()=>$('#snapAlert').addClass('d-none'), 3500);
}

function setButtons() {
  $('#btnFreeze').prop('disabled', !mediaStream || frozen);
  $('#btnClearCapture').prop('disabled', !mediaStream && !frozen);
  $('#btnCropSave').prop('disabled', !selection || !frozen);
  $('#btnDownloadLocal').prop('disabled', !frozen);
}

$('#btnStartCapture').on('click', async function(){
  try {
    // HTTPS gerekli; localhost’ta çalışır.
    mediaStream = await navigator.mediaDevices.getDisplayMedia({
      video: { displaySurface: "monitor", cursor: "always" },
      audio: false
    });
    video.srcObject = mediaStream;
    video.classList.remove('d-none');
    canvas.classList.add('d-none');
    overlay.style.display = 'none';
    rect.style.display = 'none';
    frozen = false;
    selection = null;
    setButtons();
  } catch (e) {
    showSnapError('Ekran paylaşımı reddedildi: ' + e.message);
  }
});

$('#btnFreeze').on('click', function(){
  if (!mediaStream) return;
  // video frame'i canvas'a çiz
  const area = document.getElementById('captureArea');
  const vw = video.videoWidth || area.clientWidth;
  const vh = video.videoHeight || area.clientHeight;
  // canvas element boyutunu gerçek piksele ayarla
  canvas.width = vw;
  canvas.height = vh;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, vw, vh);

  // yayını durdur
  mediaStream.getTracks().forEach(t => t.stop());
  mediaStream = null;
  frozen = true;

  // video gizle, canvas göster
  video.classList.add('d-none');
  canvas.classList.remove('d-none');

  // seçim overlay'i aç
  overlay.style.display = 'block';
  rect.style.display = 'none';
  selection = null;
  setButtons();
});

$('#btnClearCapture').on('click', function(){
  if (mediaStream) {
    mediaStream.getTracks().forEach(t => t.stop());
    mediaStream = null;
  }
  frozen = false;
  selection = null;
  video.classList.remove('d-none');
  canvas.classList.add('d-none');
  overlay.style.display = 'none';
  rect.style.display = 'none';
  setButtons();
});

// Seçim işaretleme
let startX=0, startY=0, isDragging=false;
overlay.addEventListener('mousedown', (e) => {
  if (!frozen) return;
  isDragging = true;
  const bounds = overlay.getBoundingClientRect();
  startX = e.clientX - bounds.left;
  startY = e.clientY - bounds.top;
  rect.style.left = startX + 'px';
  rect.style.top = startY + 'px';
  rect.style.width = '0px';
  rect.style.height = '0px';
  rect.style.display = 'block';
});
overlay.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const bounds = overlay.getBoundingClientRect();
  const x = e.clientX - bounds.left;
  const y = e.clientY - bounds.top;
  const w = Math.max(1, x - startX);
  const h = Math.max(1, y - startY);
  rect.style.left = Math.min(startX, x) + 'px';
  rect.style.top = Math.min(startY, y) + 'px';
  rect.style.width = Math.abs(w) + 'px';
  rect.style.height = Math.abs(h) + 'px';
});
overlay.addEventListener('mouseup', (e) => {
  if (!isDragging) return;
  isDragging = false;

  const bounds = overlay.getBoundingClientRect();
  const left = parseFloat(rect.style.left);
  const top = parseFloat(rect.style.top);
  const width = parseFloat(rect.style.width);
  const height = parseFloat(rect.style.height);

  // Overlay (CSS pikseli) -> Canvas (gerçek piksel) ölçekte dönüştür
  const scaleX = canvas.width / bounds.width;
  const scaleY = canvas.height / bounds.height;

  selection = {
    x: Math.round(left * scaleX),
    y: Math.round(top * scaleY),
    w: Math.round(width * scaleX),
    h: Math.round(height * scaleY)
  };
  setButtons();
});

// PNG indir (lokale)
$('#btnDownloadLocal').on('click', function(){
  if (!frozen) return;
  let outCanvas = document.createElement('canvas');
  const ctx = outCanvas.getContext('2d');
  if (selection && selection.w > 1 && selection.h > 1) {
    outCanvas.width = selection.w;
    outCanvas.height = selection.h;
    ctx.drawImage(canvas,
      selection.x, selection.y, selection.w, selection.h,
      0, 0, selection.w, selection.h
    );
  } else {
    outCanvas.width = canvas.width;
    outCanvas.height = canvas.height;
    ctx.drawImage(canvas, 0, 0);
  }
  outCanvas.toBlob((blob)=>{
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'snap.png';
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
});

// Sunucuya gönder ve kaydet
$('#btnCropSave').on('click', function(){
  if (!JWT) { showSnapError('Önce giriş yapın.'); return; }
  if (!frozen) { showSnapError('Önce kare dondurun.'); return; }
  const title = $('#snapTitle').val()?.trim();
  if (!title) { showSnapError('Başlık zorunlu.'); return; }
  const subtitle = $('#snapSubtitle').val()?.trim() || '';

  let outCanvas = document.createElement('canvas');
  const ctx = outCanvas.getContext('2d');
  if (selection && selection.w > 1 && selection.h > 1) {
    outCanvas.width = selection.w;
    outCanvas.height = selection.h;
    ctx.drawImage(canvas,
      selection.x, selection.y, selection.w, selection.h,
      0, 0, selection.w, selection.h
    );
  } else {
    outCanvas.width = canvas.width;
    outCanvas.height = canvas.height;
    ctx.drawImage(canvas, 0, 0);
  }

  outCanvas.toBlob(function(blob){
    if (!blob) { showSnapError('PNG oluşturulamadı.'); return; }
    const fd = new FormData();
    fd.append('image', blob, 'snap.png');
    fd.append('title', title);
    fd.append('subtitle', subtitle);

    $.ajax({
      url: api.snaps,
      method: 'POST',
      data: fd,
      processData: false,
      contentType: false,
      beforeSend: setAuthHeader,
      success: function(){
        $('#snapTitle').val('');
        $('#snapSubtitle').val('');
        selection = null;
        rect.style.display = 'none';
        loadSnaps();
      },
      error: function(xhr){
        const msg = xhr?.responseJSON?.error || xhr?.responseText || 'Kaydetme hatası';
        showSnapError(msg);
      }
    });
  }, 'image/png');
});

function loadSnaps(){
  $.ajax({
    url: api.snaps, method: 'GET', beforeSend: setAuthHeader,
    success: function(rows){
      const list = $('#snapsList').empty();
      rows.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      rows.forEach(r => {
        const col = $('<div class="col-6"></div>');
        const card = $('<div class="border rounded p-2 h-100"></div>');
        const img = $('<img class="img-fluid rounded mb-1" alt="snap">')
          .attr('src', `/api/snaps/${r.id}/image`);
        const cap = $('<div class="small"></div>').html(
          `<strong>${r.title || ''}</strong><br><span class="text-muted">${r.subtitle || ''}</span>`
        );
        card.append(img).append(cap);
        col.append(card);
        list.append(col);
      });
    }
  });
}
$('#btnRefreshSnaps').on('click', loadSnaps);

// Bu tab açıldığında kayıtları yükle
$('a[href="#tabSnap"]').on('shown.bs.tab', loadSnaps);

// Başlangıç düğme halleri
setButtons();









// auto load if already token (none initially)
</script>
</body>
</html>
