<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bookstore CRUD (Spring Boot + JWT)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Bookstore</a>
    <div class="ms-auto text-white">
      <span id="userInfo"></span>
      <button id="btnLogout" class="btn btn-sm btn-outline-light ms-2 d-none">Çıkış</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row">
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-header">Giriş</div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Kullanıcı Adı</label>
            <input id="username" class="form-control" value="admin">
          </div>
          <div class="mb-2">
            <label class="form-label">Şifre</label>
            <input id="password" type="password" class="form-control" value="admin">
            <div class="form-text">Varsayılan kullanıcı: admin / şifre: admin (DB hash uyumlu)</div>
          </div>
          <button id="btnLogin" class="btn btn-primary w-100">Giriş Yap</button>
          <div id="loginAlert" class="alert alert-danger mt-2 d-none"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Yardım</div>
        <div class="card-body small">
          <ul>
            <li>Önce giriş yapın (JWT alır).</li>
            <li>Token otomatik olarak Authorization: Bearer ... başlığına eklenir.</li>
            <li>CRUD sekmelerini kullanarak kayıt ekle/güncelle/sil yapabilirsiniz.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <ul class="nav nav-tabs" id="crudTabs">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabBooks">Kitaplar</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabCustomers">Müşteriler</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabOrders">Siparişler</a></li>
      </ul>
      <div class="tab-content border border-top-0 bg-white p-3">
        <!-- Books -->
        <div class="tab-pane fade show active" id="tabBooks">
          <form id="bookForm" class="row g-2">
            <input type="hidden" id="bookId">
            <div class="col-md-6"><label class="form-label">Ad</label><input id="bookName" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Yazar(lar)</label><input id="bookAuthors" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">ISBN</label><input id="bookIsbn" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Fiyat</label><input id="bookPrice" class="form-control" type="number" step="0.01"></div>
            <div class="col-md-4"><label class="form-label">Yayın Tarihi</label><input id="bookPublishedOn" class="form-control" type="date"></div>
            <div class="col-md-12"><label class="form-label">Yayınevi</label><input id="bookPublisher" class="form-control"></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="bookReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="booksTable">
            <thead><tr><th>ID</th><th>Ad</th><th>Yazar</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Customers -->
        <div class="tab-pane fade" id="tabCustomers">
          <form id="customerForm" class="row g-2">
            <input type="hidden" id="customerId">
            <div class="col-md-6"><label class="form-label">Ad</label><input id="custName" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Soyad</label><input id="custSurname" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Email</label><input id="custEmail" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Telefon</label><input id="custPhone" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Şehir</label><input id="custCity" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Ülke/İl</label><input id="custCountry" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Posta Kodu</label><input id="custPostal" class="form-control"></div>
            <div class="col-md-12"><label class="form-label">Adres</label><input id="custAddress" class="form-control"></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="customerReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="customersTable">
            <thead><tr><th>ID</th><th>Ad Soyad</th><th>Email</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Orders -->
        <div class="tab-pane fade" id="tabOrders">
          <form id="orderForm" class="row g-2">
            <input type="hidden" id="orderId">
            <div class="col-md-4"><label class="form-label">Tarih</label><input id="orderDate" type="date" class="form-control"></div>
            <div class="col-md-4"><label class="form-label">Kitap</label><select id="orderBook" class="form-select"></select></div>
            <div class="col-md-4"><label class="form-label">Müşteri</label><select id="orderCustomer" class="form-select"></select></div>
            <div class="col-12">
              <button type="submit" class="btn btn-success">Kaydet</button>
              <button type="button" id="orderReset" class="btn btn-secondary">Temizle</button>
            </div>
          </form>
          <hr>
          <table class="table table-striped" id="ordersTable">
            <thead><tr><th>ID</th><th>Tarih</th><th>Kitap</th><th>Müşteri</th><th>İşlem</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const api = {
  login: '/api/auth/login',
  books: '/api/books',
  customers: '/api/customers',
  orders: '/api/orders'
};
let JWT = null;

function setAuthHeader(xhr) {
  if (JWT) xhr.setRequestHeader('Authorization', 'Bearer ' + JWT);
}

function showAlert(el, msg) {
  $(el).removeClass('d-none').text(msg);
  setTimeout(()=> $(el).addClass('d-none'), 2500);
}

$('#btnLogin').on('click', function() {
  $.ajax({
    url: api.login,
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({username: $('#username').val(), password: $('#password').val()}),
    success: function(res){
      JWT = res.token;
      $('#userInfo').text(res.username + ' | ' + res.roles.join(','));
      $('#btnLogout').removeClass('d-none');
      $('.nav-link[href="#tabBooks"]').tab('show');
      refreshAll();
    },
    error: function(){
      showAlert('#loginAlert','Giriş başarısız');
    }
  });
});

$('#btnLogout').on('click', function(){
  JWT = null;
  $('#userInfo').text('');
  $('#btnLogout').addClass('d-none');
});

// Books CRUD
function refreshBooks(){
  $.ajax({
    url: api.books, method: 'GET', beforeSend: setAuthHeader,
    success: function(rows){
      const tbody = $('#booksTable tbody').empty();
      rows.forEach(r => {
        $('<tr>').append(
          $('<td>').text(r.id),
          $('<td>').text(r.name),
          $('<td>').text(r.authors),
          $('<td>').append(
            $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadBook(r)),
            $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteBook(r.id))
          )
        ).appendTo(tbody);
      });
      // also update order dropdowns
      const sel = $('#orderBook').empty();
      rows.forEach(r => sel.append($('<option>').val(r.id).text(r.name)));
    }
  });
}

function loadBook(b){
  $('#bookId').val(b.id);
  $('#bookName').val(b.name);
  $('#bookAuthors').val(b.authors);
  $('#bookIsbn').val(b.isbn);
  $('#bookPrice').val(b.price);
  $('#bookPublishedOn').val(b.publishedOn);
  $('#bookPublisher').val(b.publisher);
}

function deleteBook(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.books + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshBooks});
}

$('#bookForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    name: $('#bookName').val(),
    authors: $('#bookAuthors').val(),
    isbn: $('#bookIsbn').val(),
    price: $('#bookPrice').val() ? parseFloat($('#bookPrice').val()) : null,
    publishedOn: $('#bookPublishedOn').val(),
    publisher: $('#bookPublisher').val()
  };
  const id = $('#bookId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.books + '/' + id : api.books;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#bookForm')[0].reset(); $('#bookId').val(''); refreshBooks();
  }});
});
$('#bookReset').on('click', ()=> { $('#bookForm')[0].reset(); $('#bookId').val(''); });

// Customers CRUD
function refreshCustomers(){
  $.ajax({url: api.customers, method: 'GET', beforeSend: setAuthHeader, success: function(rows){
    const tbody = $('#customersTable tbody').empty();
    rows.forEach(r => {
      $('<tr>').append(
        $('<td>').text(r.id),
        $('<td>').text(r.name + ' ' + r.surname),
        $('<td>').text(r.email),
        $('<td>').append(
          $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadCustomer(r)),
          $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteCustomer(r.id))
        )
      ).appendTo(tbody);
    });
    const sel = $('#orderCustomer').empty();
    rows.forEach(r => sel.append($('<option>').val(r.id).text(r.name + ' ' + r.surname)));
  }});
}

function loadCustomer(c){
  $('#customerId').val(c.id);
  $('#custName').val(c.name);
  $('#custSurname').val(c.surname);
  $('#custEmail').val(c.email);
  $('#custPhone').val(c.phoneNumber);
  $('#custCity').val(c.city);
  $('#custCountry').val(c.countryRegion);
  $('#custPostal').val(c.postalCode);
  $('#custAddress').val(c.streetAndHouseNumber);
}

function deleteCustomer(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.customers + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshCustomers});
}

$('#customerForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    name: $('#custName').val(),
    surname: $('#custSurname').val(),
    email: $('#custEmail').val(),
    phoneNumber: $('#custPhone').val(),
    city: $('#custCity').val(),
    countryRegion: $('#custCountry').val(),
    postalCode: $('#custPostal').val(),
    streetAndHouseNumber: $('#custAddress').val()
  };
  const id = $('#customerId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.customers + '/' + id : api.customers;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#customerForm')[0].reset(); $('#customerId').val(''); refreshCustomers();
  }});
});
$('#customerReset').on('click', ()=> { $('#customerForm')[0].reset(); $('#customerId').val(''); });

// Orders CRUD
function refreshOrders(){
  $.ajax({url: api.orders, method: 'GET', beforeSend: setAuthHeader, success: function(rows){
    const tbody = $('#ordersTable tbody').empty();
    rows.forEach(r => {
      $('<tr>').append(
        $('<td>').text(r.id),
        $('<td>').text(r.orderDate),
        $('<td>').text(r.book ? r.book.name : ''),
        $('<td>').text(r.customer ? (r.customer.name + ' ' + r.customer.surname) : ''),
        $('<td>').append(
          $('<button class="btn btn-sm btn-primary me-1">Düzenle</button>').on('click', ()=>loadOrder(r)),
          $('<button class="btn btn-sm btn-danger">Sil</button>').on('click', ()=>deleteOrder(r.id))
        )
      ).appendTo(tbody);
    });
  }});
}
function loadOrder(o){
  $('#orderId').val(o.id);
  $('#orderDate').val(o.orderDate);
  $('#orderBook').val(o.book ? o.book.id : '');
  $('#orderCustomer').val(o.customer ? o.customer.id : '');
}
function deleteOrder(id){
  if(!confirm('Silinsin mi?')) return;
  $.ajax({url: api.orders + '/' + id, method: 'DELETE', beforeSend: setAuthHeader, success: refreshOrders});
}
$('#orderForm').on('submit', function(e){
  e.preventDefault();
  const payload = {
    orderDate: $('#orderDate').val(),
    book: { id: $('#orderBook').val() ? parseInt($('#orderBook').val()) : null},
    customer: { id: $('#orderCustomer').val() ? parseInt($('#orderCustomer').val()) : null}
  };
  const id = $('#orderId').val();
  const method = id ? 'PUT' : 'POST';
  const url = id ? api.orders + '/' + id : api.orders;
  $.ajax({url, method, contentType:'application/json', data: JSON.stringify(payload), beforeSend: setAuthHeader, success: function(){
    $('#orderForm')[0].reset(); $('#orderId').val(''); refreshOrders();
  }});
});
$('#orderReset').on('click', ()=> { $('#orderForm')[0].reset(); $('#orderId').val(''); });

function refreshAll(){
  refreshBooks();
  refreshCustomers();
  refreshOrders();
}

// auto load if already token (none initially)
</script>
</body>
</html>
